---
import { Submission, db } from "astro:db";
import { createForm, validateForm } from "simple:form";
import z from "zod";
import Layout from "~/layouts/Layout.astro";

const submissionForm = createForm({
  integrationURL: z.string().min(1),
  authorURL: z.string().min(1),
  isAuthor: z.boolean(),
  message: z.string().optional(),
});

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const parsed = await validateForm({
      formData,
      validator: submissionForm.validator,
    });
    if (parsed.data) {
      // @ts-ignore - TODO: fix this
      await db.insert(Submission).values({
        integration_url: parsed.data.integrationURL,
        author_url: parsed.data.authorURL,
        is_author: parsed.data.isAuthor,
        message: parsed.data.message,
      });
      return Astro.redirect("/submit/success");
    } else {
      console.warn(parsed.fieldErrors);
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---

<Layout title="Submit a project">
  <h1 class="text-center mt-14 font-heading uppercase font-extrabold text-2xl">
    Submit a project for Astrolicous
  </h1>
  <form method="POST" class="flex flex-col max-w-5xl mx-auto my-14">
    <div class="mb-3 flex flex-col">
      <label for="integrationURL"
        >URL of the project. (URL should show purpose of Project) *</label
      >
      <input
        id="integrationURL"
        {...submissionForm.inputProps.integrationURL}
        required
      />
    </div>

    <div class="mb-3 flex flex-col">
      <label for="authorURL"
        >URL of the Author. (URL should allow to a contact, e.g. GitHub, Mail,
        Discord) *</label
      >
      <input id="authorURL" {...submissionForm.inputProps.authorURL} required />
    </div>

    <div class="mb-3 flex items-center gap-2">
      <label for="isAuthor">Are you the Author?</label>
      <input id="isAuthor" {...submissionForm.inputProps.isAuthor} />
    </div>

    <div class="mb-3 flex flex-col">
      <label for="isAuthor">Do you want to add a message?</label>
      <input id="isAuthor" {...submissionForm.inputProps.message} />
    </div>

    <button
      class="mt-4 block w-full rounded-md bg-primary-600 text-white p-2 font-heading text-lg font-extrabold uppercase hover:bg-primary-700 transition-colors focus:ring-0"
    >
      Submit
    </button>
  </form>
</Layout>
